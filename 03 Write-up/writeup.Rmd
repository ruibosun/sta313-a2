---
title: "CHANGE TITLE"
author: "Ruibo Sun and Nixi Huang"
date: "`r Sys.time()`"
output: pdf_document
abstract: ADD ABSTRACT
format: pdf
number-sections: true
date-format: D MMMM YYYY
---

```{r}
#| include: false
#| warning: false
#| message: false

# read packages
library(tidyverse)
library(dplyr)
library(readr)
library(ggmap)
library(sf)
library(patchwork)
library(here)
```


```{r}
#| include: false
#| warning: false
#| message: false


# import data

bike_raw_raw <- read_csv(here("01 Input","Bicycle_Thefts_Open_Data.csv"))
neighbourhood_data <- read_csv(here("01 Input","Neighbourhood_Crime_Rates_Open_Data.csv"))
# lane <- read_csv("01 Input/cycling-network - 4326.csv")
toronto_neighborhoods <- st_read(here("01 Input", "toneighshape", "Neighbourhoods v2_region.shp"))

shape <- st_read(here("01 Input", "cycling-network - 4326", "cycling-network - 4326.shp"))

# data cleaning
bike_raw <- bike_raw_raw %>% filter(OCC_YEAR>2013)

bike_raw$y_n <- ifelse(bike_raw$STATUS =='RECOVERED','Yes','NO')
```

```{r}
#| include: false
#| warning: false
#| message: false

# general <- bike_raw %>%
#   group_by(NEIGHBOURHOOD_158, OCC_YEAR) %>%
#   summarise(
#     Thefts = n(),  # Total thefts
#     Recovered = sum(y_n == 'Yes'),  
#     .groups = 'drop'
#   ) %>%
#   arrange(NEIGHBOURHOOD_158, OCC_YEAR)
# 
# top_neighborhoods <- average_bike_thefts %>%
#   arrange(desc(average_bike_thefts)) %>%
#   top_n(5, average_bike_thefts)
# 
# 
# data_premise <- bike_raw %>%
#   filter(NEIGHBOURHOOD_158 %in% top_neighborhoods$AREA_NAME) %>% # Replace 'NEIGHBORHOOD' with the actual column name
#   group_by(PREMISES_TYPE) %>% # Replace 'PREMISE_TYPE' with the actual column name
#   count(HOTSPOT = NEIGHBOURHOOD_158) %>% # Count occurrences by premise type within each hotspot
#   ungroup() %>%
#   group_by(PREMISES_TYPE) %>%
#   mutate(total = sum(n)) %>%
#   ungroup() %>%
#   mutate(prop = n / total)
# 
# unique_hotspots <- unique(data_premise$HOTSPOT)


neighbourhood_data <- read_csv(here("01 Input","Neighbourhood_Crime_Rates_Open_Data.csv"))

average_bike_thefts <- neighbourhood_data %>%
  # Select the HOOD_ID and BIKETHEFT columns
  select(AREA_NAME, starts_with("BIKETHEFT_")) %>%
  # Gather the year columns into key-value pairs
  gather(key = "year", value = "bike_thefts", -AREA_NAME) %>%
  # Extract the year from the column names
  mutate(year = as.numeric(sub("BIKETHEFT_", "", year))) %>%
  # Calculate the average thefts per neighborhood
  group_by(AREA_NAME) %>%
  summarise(average_bike_thefts = mean(bike_thefts, na.rm = TRUE)) %>%
  ungroup()


toronto_thefts_rate <- merge(toronto_neighborhoods, average_bike_thefts, 
                            by.x = "NAME", by.y = "AREA_NAME")

threshold <- median(average_bike_thefts$average_bike_thefts)  

average_bike_thefts <- average_bike_thefts %>%
  mutate(Theft_Level = if_else(average_bike_thefts >= threshold, "Area with High Theft Rate", "Area with Low Theft Rate")) %>% rename('NEIGHBOURHOOD_158'='AREA_NAME')



average_bike_cost <- bike_raw %>%
  group_by(NEIGHBOURHOOD_158) %>%  # Replace with the correct neighborhood column name
  summarise(Average_Bike_Cost = mean(BIKE_COST, na.rm = TRUE))


combined_data <- average_bike_thefts %>%
  left_join(average_bike_cost, by = 'NEIGHBOURHOOD_158') 


# add
general <- bike_raw %>%
  group_by(NEIGHBOURHOOD_158, OCC_YEAR) %>%
  summarise(
    Thefts = n(),  # Total thefts
    Recovered = sum(y_n == 'Yes'),  
    .groups = 'drop'
  ) %>%
  arrange(NEIGHBOURHOOD_158, OCC_YEAR)

top_neighborhoods <- average_bike_thefts %>%
  arrange(desc(average_bike_thefts)) %>%
  top_n(5, average_bike_thefts)


data_premise <- bike_raw %>%
  filter(NEIGHBOURHOOD_158 %in% top_neighborhoods$NEIGHBOURHOOD_158) %>% # Replace 'NEIGHBORHOOD' with the actual column name
  group_by(PREMISES_TYPE) %>% # Replace 'PREMISE_TYPE' with the actual column name
  count(HOTSPOT = NEIGHBOURHOOD_158) %>% # Count occurrences by premise type within each hotspot
  ungroup() %>%
  group_by(PREMISES_TYPE) %>%
  mutate(total = sum(n)) %>%
  ungroup() %>%
  mutate(prop = n / total)

unique_pre <- unique(data_premise$PREMISES_TYPE)

```

```{r}
#| include: false
#| warning: false
#| message: false
hour_plot <- left_join(bike_raw, average_bike_thefts, by = 'NEIGHBOURHOOD_158')

hour_plot$OCC_HOUR <- as.factor(hour_plot$OCC_HOUR)
if("0" %in% levels(hour_plot$OCC_HOUR)) {
  levels(hour_plot$OCC_HOUR)[levels(hour_plot$OCC_HOUR) == "0"] <- "0/24"
}

hour_plot <- hour_plot %>% mutate(`Premises Type` = if_else(PREMISES_TYPE %in% c("Apartment", "House"), "Private Spaces", "Public Access Areas"))

```

```{r}
#| include: false
#| warning: false
#| message: false

yearly_counts <- bike_raw %>% filter(OCC_YEAR>2000) %>%
  group_by(OCC_YEAR, y_n) %>%
  summarise(count = n(), .groups = 'drop')

ggplot(yearly_counts, aes(x = OCC_YEAR, y = count, color = y_n)) +
  geom_line() +  # Line plot
  geom_point() + # Add points to the lines
  labs(title = "Yearly Bike Recovery Status", 
       x = "Year of Occurrence", 
       y = "Number of Bikes",
       color = "Recovery Status") +
  theme_minimal() +
  scale_x_continuous(breaks = unique(yearly_counts$OCC_YEAR))  

```

```{r}
#| include: false
#| warning: false
#| message: false

register_stadiamaps(key = "ddfcfc93-13e6-497f-8336-c5fdd043f311")

toronto_map <- get_stadiamap(bbox = c(left = -79.639219, bottom = 43.581024, right = -79.113219, top = 43.855457), 
                             maptype = "stamen_toner_lite", 
                             zoom = 12)
# data cleaning
bike_aggregated <- bike_raw %>%
  group_by(LONG_WGS84, LAT_WGS84) %>%
  summarise(count = n(), .groups = 'drop')
```

```{r}
#| include: false
#| warning: false
#| message: false
ggmap(toronto_map) +
  geom_point(data = bike_aggregated, aes(x = LONG_WGS84, y = LAT_WGS84, color = count), alpha = 0.5) +
  scale_color_gradient(low = "lightblue", high = "black") +  # Adjust color gradient as needed
  labs(title = "Incident Occurrences in Toronto", 
       x = "Longitude", 
       y = "Latitude",
       color = "Number of Occurrences") +
  theme_minimal()
```

## Sub-question 1: Where do the highest numbers of bike thefts occur in Toronto?

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-map1
#| fig-cap: Average Bike Thefts in Toronto by Neighborhood
#| fig-width: 8
#| fig-height: 4


bike_thefts_avg <- bike_raw %>%
  group_by(NEIGHBOURHOOD_158, OCC_YEAR) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(NEIGHBOURHOOD_158) %>%
  summarise(avg_count = mean(count), .groups = 'drop')


toronto_thefts_geo <- merge(toronto_neighborhoods, bike_thefts_avg, 
                            by.x = "NAME", by.y = "NEIGHBOURHOOD_158")

ggplot(toronto_thefts_geo) +
  geom_sf(aes(fill = avg_count), color = "white", size = 0.2) +
  scale_fill_gradient(low = "beige", high = "darkred") +  # Adjust color scale as needed
  labs( 
       fill = "Average number of thefts \n each year") +
  theme_minimal() +
  theme(legend.position = "right", panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-map2
#| fig-cap: Bike Thefts Crime Rate and Bike Lanes in Toronto by Neighborhood
#| fig-width: 8
#| fig-height: 4


ggplot(toronto_thefts_rate) +
  geom_sf(aes(fill = average_bike_thefts), color = "white", size = 0.8) +
  geom_sf(data = shape, color = "black", size = 2, inherit.aes = FALSE, alpha = 0.3) +
  scale_fill_gradient(low = "beige", high = "#8D021F") +  # Adjust color scale as needed
  labs(
       fill = " Number of \n bike thefts crimes \n per 100,000 \n population each year") +
  theme_minimal() +
  theme(legend.position = "right", panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```
```{r}
ggplot(toronto_thefts_rate) +
  geom_sf(aes(fill = average_bike_thefts), color = "white", size = 0.2) +  # Reduced border size
  geom_sf(data = shape, color = "black", size = 0.5, inherit.aes = FALSE, alpha = 0.3) +  # Reduced border size and transparency
  scale_fill_gradient(low = "beige", high = "#8D021F", 
                      breaks = c(100, 200, 400, 600), 
                      labels = c("Low", "Moderate", "High", "Very High")) +  # More descriptive breaks
  labs(
    fill = "Average Number of \n crimes per 100,000 \n population each year"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right", 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank())  # Adjusting margin if needed
  

```


## Sub-question 2: Are there any time trends in bike thefts in these high-risk areas?

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-top5
#| fig-cap: Trend of Bike Thefts Over Time in the Top 5 Hotspots
#| fig-width: 8
#| fig-height: 4

theft_trends <- bike_raw %>%
  filter(NEIGHBOURHOOD_158 %in% top_neighborhoods$NEIGHBOURHOOD_158) %>%
  group_by(NEIGHBOURHOOD_158, OCC_YEAR) %>%
  summarise(Thefts = n(), .groups = 'drop') %>%
  arrange(NEIGHBOURHOOD_158, OCC_YEAR)

theft_trends <- bike_raw %>%
  filter(NEIGHBOURHOOD_158 %in% top_neighborhoods$NEIGHBOURHOOD_158) %>%
  group_by(NEIGHBOURHOOD_158, OCC_YEAR) %>%
  summarise(
    Thefts = n(),  # Total thefts
    Recovered = sum(y_n == 'Yes'),  # Count of recovered bikes
    .groups = 'drop'
  ) %>%
  arrange(NEIGHBOURHOOD_158, OCC_YEAR)

custom_colors <- c("Yonge-Bay Corridor" = "#E69F00", "University" = "#56B4E9", 
                   "Downtown Yonge East" = "#009E73", "Wellington Place" = "#CC79A7", 
                   "Kensington-Chinatown" = "#0072B2")

# Plotting the theft trends with custom colors
ggplot(theft_trends, aes(x = OCC_YEAR, y = Thefts, group = NEIGHBOURHOOD_158, color = NEIGHBOURHOOD_158)) +
  geom_line() +
  scale_color_manual(values = custom_colors) +
  scale_x_continuous(breaks = seq(min(theft_trends$OCC_YEAR), max(theft_trends$OCC_YEAR), by = 1)) +
  scale_y_continuous(limits = c(floor(min(theft_trends$Thefts)/10)*10, ceiling(max(theft_trends$Thefts)/10)*10),
                     breaks = seq(floor(min(theft_trends$Thefts)/10)*10, ceiling(max(theft_trends$Thefts)/10)*10, by = 50)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(
       x = "Year",
       y = "Number of Thefts",
       color = "Location")

```

## Sub-question 3: How do patterns of bike thefts in Toronto vary between Private Spaces and Public Access Areas throughout the day in Toronto?

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-clock
#| fig-cap: Bike Theft Trends by Hour (Private vs. Public Spaces)
#| fig-width: 8
#| fig-height: 4

hour_plot <- hour_plot %>%
  mutate(season = if_else(OCC_MONTH %in% c("December", "January", "February", "March", "April", "November"), 'Cold', 'Warm'))

degrees_to_rotate <- 8
radians_to_rotate <- degrees_to_rotate * (pi / 180)

premises_type_colors <- c('Private Spaces' = '#2E86C1', 'Public Access Areas' = '#1ABC9C')

ggplot(hour_plot, aes(x = OCC_HOUR, fill = `Premises Type`)) +
  geom_bar() +
  scale_x_discrete(drop = FALSE) + # Include all levels, even if some have no data
  coord_polar(start = 0 - radians_to_rotate) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),  
    panel.grid.major.y = element_blank(),  
    panel.grid.minor.y = element_blank(),
    axis.title.x = element_blank(), 
    axis.title.y = element_blank()
  ) +
  scale_fill_manual(values = premises_type_colors)
```

## Sub-question 4: How does the type of area (residential, commercial, industrial) influence bike theft rates?

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-prop
#| fig-cap: Proportional Distribution of Bike Thefts Across Premises Types in Toronto Top 5 Hotspots
#| fig-width: 8
#| fig-height: 4


my_colors <- setNames(c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7"), unique_pre)


ggplot(data_premise, aes(x = HOTSPOT, y = prop, fill = PREMISES_TYPE)) +
  geom_bar(stat = "identity", position = position_fill(reverse = TRUE), width = 0.7) +
  # geom_text(aes(label = scales::percent(prop, accuracy = 1)), 
  #           position = position_fill(vjust = 0.5), size = 2.5, color = "white") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = my_colors) +
  labs(x = "Hot Spot", y = "Proportion of Thefts", fill = "Premises Type") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box = "vertical",
        text = element_text(size = 8),
        axis.text.x = element_text(size = 6),
        legend.text = element_text(size = 6)) +
  guides(fill = guide_legend(nrow = 2))
```

## Sub-question 5: What are the cost profiles of bicycles stolen in Toronto? 

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-cost
#| fig-cap: Comparative Density of Bicycle Costs in Areas with High and Low Theft Rates
#| fig-width: 8
#| fig-height: 4

ggplot(combined_data, aes(x = Average_Bike_Cost, fill = Theft_Level)) +
  geom_density(alpha = 0.5) +  # Set transparency to see overlapping areas
  scale_fill_manual(values = c("Area with High Theft Rate" = "#C0392B", "Area with Low Theft Rate" = "#3498DB")) +  # Deep red and blue-green
  labs(
    x = "Average Bike Cost ($)",
    y = "Density",
    fill = "Theft Rate Level"
  ) +
  theme_minimal() +
  theme(legend.position = "right")
```


```{r}
#| include: false
#| warning: false
#| message: false
# data cleaning

bike_p <- bike_raw %>% mutate(cost_level = case_when(
  BIKE_COST <= 500 ~ "0-500",
  (BIKE_COST > 500 & BIKE_COST <= 1000) ~ "501-1000",
  (BIKE_COST > 1001 & BIKE_COST <= 1500) ~ "1001-1500",
  BIKE_COST > 1501 ~ "1500+"
)) 
bike_p$cost_level <- factor(bike_p$cost_level, levels = c("0-500", "501-1000", "10001-1500", "1500+"))
```


```{r}
#| include: false
#| warning: false
#| message: false

bike_p <- bike_raw %>%
  mutate(cost_level = case_when(
    BIKE_COST >= 1000 ~ "Expensive",
    BIKE_COST < 1000 ~ "Affordable"
  ))

bike_p$cost_level <- factor(bike_p$cost_level, levels = c("Affordable", "Expensive"))
```



